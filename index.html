<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Allocation & Objectif ‚Äî Kevin Croy</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
:root{
  --bg:#0c1117; --panel:#121826; --muted:#9aa3b2; --text:#e8edf2;
  --outline:rgba(255,255,255,.08); --ring:rgba(46,168,255,.25);
  --green:#22c55e; --blue:#60a5fa; --amber:#f59e0b; --rose:#fb7185; --grey:#cbd5e1;
}
*{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
header{position:sticky;top:0;z-index:30;background:#0c1117cc;backdrop-filter:blur(8px);border-bottom:1px solid var(--outline)}
header .bar{max-width:1280px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center}
.dot{width:10px;height:10px;border-radius:50%;background:#22c55e}
h1{font-size:18px;margin:0}
.badge{border:1px solid var(--outline);color:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px}
.spacer{flex:1}
.btn{background:#111827;border:1px solid var(--outline);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,#16a34a,#22c55e);color:#06240f;border:none;font-weight:700}
.wrap{max-width:1280px;margin:0 auto;padding:20px 16px 80px}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:1100px){.grid{grid-template-columns:1.15fr .85fr}}
.card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid var(--outline);border-radius:16px;padding:16px}
.row{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
input,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--outline);background:#0f1522;color:var(--text)}
input:focus,select:focus{border-color:#2ea8ff;box-shadow:0 0 0 4px var(--ring)}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
.kpi{background:rgba(255,255,255,.04);border:1px solid var(--outline);border-radius:12px;padding:10px}
.kpi .lab{font-size:12px;color:var(--muted)} .kpi .val{font-weight:700;font-size:18px;margin-top:2px}
table{width:100%;border-collapse:collapse;font-size:14px}
thead th{background:rgba(255,255,255,.05);padding:10px;color:#cbd5e1;text-align:left;position:sticky;top:0}
tbody td{border-top:1px solid var(--outline);padding:8px}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.tag{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--outline);color:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px}
.small{font-size:12px;color:#aab6c4}
.hr{height:1px;background:var(--outline);margin:12px 0}
.pies{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:900px){.pies{grid-template-columns:repeat(3,1fr)}}
.add{margin-top:10px}
.del{background:#1f2937;border:1px solid #334155;color:#fda4af;border-radius:8px;cursor:pointer;padding:6px 10px}
tfoot td{border-top:2px solid var(--outline);padding:10px;font-weight:700}
.help{font-size:12px;color:#cfe8ff}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="dot"></div>
    <h1>Allocation & Objectif ‚Äî <strong>Kevin Croy</strong></h1>
    <span class="badge">Tableaux + Pies</span>
    <div class="spacer"></div>
    <button id="csv" class="btn">Exporter CSV</button>
    <button id="reset" class="btn">R√©initialiser</button>
    <button id="clear" class="btn">Effacer la sauvegarde</button>
    <button id="save" class="btn primary">Enregistrer</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- GAUCHE : param√®tres + tableau -->
    <div class="card">
      <h3 style="margin:0 0 10px">Param√®tres</h3>
      <div class="row">
        <div><div class="small">Objectif (EUR)</div><input id="goal" type="number" value="3000000"></div>
        <div><div class="small">EUR ‚Üí USD</div><input id="eurusd" type="number" step="0.0001" value="1.04"></div>
        <div><div class="small">EUR ‚Üí CHF</div><input id="eurchf" type="number" step="0.0001" value="0.94"></div>
        <div><div class="small">Derni√®re MAJ</div><input id="last" type="date"></div>
        <div><div class="small">Devise d‚Äôaffichage</div>
          <select id="display">
            <option value="EUR" selected>EUR</option>
            <option value="USD">USD</option>
            <option value="CHF">CHF</option>
          </select>
        </div>
        <div class="help" style="align-self:end">üíæ Auto-sauvegarde locale ‚Äî CSV pour Excel</div>
      </div>

      <div class="hr"></div>
      <div class="actions">
        <span class="tag">Type: <span class="small">Crypto / Actions / Cash / Immobilier‚Ä¶</span></span>
        <span class="tag">Secteur: <span class="small">Private equities / Immobilier / Banques‚Ä¶</span></span>
        <span class="tag">Pays: <span class="small">FR/CH/UK/US/AE‚Ä¶</span></span>
      </div>

      <div class="hr"></div>
      <h3 style="margin:0 0 8px">Positions</h3>
      <div class="help">Astuce : double-clique dans une cellule pour modifier. Ajoute des lignes avec ‚ÄúAjouter une ligne‚Äù.</div>
      <div style="overflow:auto; margin-top:6px">
        <table id="tbl">
          <thead>
            <tr>
              <th>Type</th><th>Secteur</th><th>Asset / Compte</th><th>Pays</th>
              <th>Montant (EUR)</th><th>% cible (facult.)</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr><td colspan="4">Total</td><td id="totEUR">‚Äî</td><td></td><td></td></tr>
          </tfoot>
        </table>
      </div>
      <button id="add" class="btn add">+ Ajouter une ligne</button>
    </div>

    <!-- DROITE : kpi + chart -->
    <div class="card">
      <h3 style="margin:0 0 8px">Synth√®se</h3>
      <div class="kpis">
        <div class="kpi"><div class="lab">Valeur totale</div><div id="k_total" class="val">‚Äî</div></div>
        <div class="kpi"><div class="lab">Total (USD)</div><div id="k_usd" class="val">‚Äî</div></div>
        <div class="kpi"><div class="lab">Total (CHF)</div><div id="k_chf" class="val">‚Äî</div></div>
        <div class="kpi"><div class="lab">Reste √† l‚Äôobjectif</div><div id="k_left" class="val">‚Äî</div></div>
      </div>

      <div class="hr"></div>
      <div class="pies">
        <div><div class="small">Par secteur</div><canvas id="pieSector" height="220"></canvas></div>
        <div><div class="small">Par asset</div><canvas id="pieAsset" height="220"></canvas></div>
        <div><div class="small">Par type</div><canvas id="pieType" height="220"></canvas></div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";
  const KEY = "alloc-v1";
  const fmt = (n,cur) => new Intl.NumberFormat('fr-FR',{style:'currency',currency:cur||'EUR',maximumFractionDigits:0}).format(n||0);

  // State par d√©faut (quelques lignes pour d√©marrer)
  const defaults = {
    goal: 3000000, eurusd: 1.04, eurchf: 0.94, display: "EUR",
    last: new Date().toISOString().slice(0,10),
    rows: [
      {type:"Cash", secteur:"Banques & Assurances", asset:"Compte bancaire 1", pays:"France", eur:5000, cible:""},
      {type:"Cash", secteur:"Banques & Assurances", asset:"Compte bancaire 2", pays:"Suisse", eur:25000, cible:""},
      {type:"Cryptos", secteur:"Autre", asset:"eToro / Swissquote", pays:"France", eur:5000, cible:""},
      {type:"CFDs / Fx", secteur:"Autre", asset:"Pepperstone", pays:"UK", eur:5000, cible:""},
      {type:"Immobilier", secteur:"Immobilier", asset:"SCI Immobilier", pays:"France", eur:450000, cible:""},
      {type:"Private Equities", secteur:"Private Equities", asset:"Compagnie 1", pays:"UAE", eur:75000, cible:""}
    ]
  };

  // Chargement
  function load(){
    try { return JSON.parse(localStorage.getItem(KEY)||""); } catch(e){ return null; }
  }
  let state = Object.assign({}, defaults, load()||{});
  if(!Array.isArray(state.rows)) state.rows = defaults.rows.slice();

  // DOM refs
  const tbody = document.getElementById("tbody");
  const kTot = document.getElementById("k_total");
  const kUSD = document.getElementById("k_usd");
  const kCHF = document.getElementById("k_chf");
  const kLeft= document.getElementById("k_left");
  const totEUR = document.getElementById("totEUR");
  const inputs = {
    goal: document.getElementById("goal"),
    eurusd: document.getElementById("eurusd"),
    eurchf: document.getElementById("eurchf"),
    display: document.getElementById("display"),
    last: document.getElementById("last"),
  };

  // Init inputs
  inputs.goal.value   = state.goal;
  inputs.eurusd.value = state.eurusd;
  inputs.eurchf.value = state.eurchf;
  inputs.display.value= state.display;
  inputs.last.value   = state.last;

  // Table render
  function renderRows(){
    tbody.innerHTML = "";
    state.rows.forEach((r,idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td contenteditable="true" data-k="type">${r.type||""}</td>
        <td contenteditable="true" data-k="secteur">${r.secteur||""}</td>
        <td contenteditable="true" data-k="asset">${r.asset||""}</td>
        <td contenteditable="true" data-k="pays">${r.pays||""}</td>
        <td contenteditable="true" data-k="eur">${Number(r.eur||0)}</td>
        <td contenteditable="true" data-k="cible">${r.cible||""}</td>
        <td><button class="del" data-i="${idx}">Supprimer</button></td>
      `;
      tbody.appendChild(tr);
    });
    // Listeners edit
    tbody.querySelectorAll("[contenteditable]").forEach(td=>{
      td.addEventListener("blur", e=>{
        const cell = e.currentTarget;
        const k = cell.dataset.k;
        const i = Array.from(tbody.children).indexOf(cell.parentElement);
        let val = cell.textContent.trim();
        if(k==="eur"){ val = Number(val.replace(/\s/g,"").replace(",",".")||0); }
        state.rows[i][k] = val;
        changed();
      });
      td.addEventListener("keydown", e=>{
        if(e.key==="Enter"){ e.preventDefault(); e.currentTarget.blur(); }
      });
    });
    // delete
    tbody.querySelectorAll(".del").forEach(b=>{
      b.addEventListener("click", ()=>{
        const i = Number(b.dataset.i);
        state.rows.splice(i,1);
        changed(); renderRows(); renderAll();
      });
    });
  }

  // Maths
  function compute(){
    const eur = state.rows.reduce((a,b)=> a + Number(b.eur||0), 0);
    const usd = eur * Number(state.eurusd||1);
    const chf = eur * Number(state.eurchf||1);
    const left = Math.max(0, Number(state.goal||0) - eur);
    return {eur, usd, chf, left};
  }

  // Group helpers
  function groupSum(arr, key){
    const m = new Map();
    arr.forEach(r=>{
      const k = (r[key]||"Inconnu").toString();
      m.set(k, (m.get(k)||0) + Number(r.eur||0));
    });
    return [...m.entries()].sort((a,b)=> b[1]-a[1]);
  }

  // Charts
  const pieSector = new Chart(document.getElementById("pieSector"),{type:'doughnut',data:{labels:[],datasets:[{data:[]}]},options:{plugins:{legend:{labels:{color:"#dbe2ea"}}}}});
  const pieAsset  = new Chart(document.getElementById("pieAsset"), {type:'doughnut',data:{labels:[],datasets:[{data:[]}]},options:{plugins:{legend:{labels:{color:"#dbe2ea"}}}}});
  const pieType   = new Chart(document.getElementById("pieType"),  {type:'doughnut',data:{labels:[],datasets:[{data:[]}]},options:{plugins:{legend:{labels:{color:"#dbe2ea"}}}}});

  function renderCharts(){
    const sec = groupSum(state.rows,"secteur");
    const ass = groupSum(state.rows,"asset");
    const typ = groupSum(state.rows,"type");
    const colors = ['#22c55e','#60a5fa','#f59e0b','#fb7185','#a78bfa','#34d399','#fca5a5','#93c5fd','#fbbf24','#10b981'];
    function set(pie, data){
      pie.data.labels = data.map(([k])=>k);
      pie.data.datasets[0].data = data.map(([,v])=>v);
      pie.data.datasets[0].backgroundColor = data.map((_,i)=> colors[i%colors.length]);
      pie.update('none');
    }
    set(pieSector, sec); set(pieAsset, ass); set(pieType, typ);
  }

  // KPIs
  function renderKPIs(){
    const k = compute();
    const cur = inputs.display.value;
    const factor = cur==="EUR" ? 1 : (cur==="USD" ? Number(state.eurusd||1) : Number(state.eurchf||1));
    const totalDisp = k.eur * factor;
    kTot.textContent = fmt(totalDisp, cur);
    kUSD.textContent = fmt(k.usd,'USD');
    kCHF.textContent = fmt(k.chf,'CHF');
    kLeft.textContent = fmt(k.left,'EUR');
    totEUR.textContent = fmt(k.eur,'EUR');
  }

  function renderAll(){ renderKPIs(); renderCharts(); }

  // Save
  function save(){ try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){} }
  function changed(){ save(); renderAll(); }

  // Add line
  document.getElementById("add").addEventListener("click", ()=>{
    state.rows.push({type:"",secteur:"",asset:"",pays:"",eur:0,cible:""});
    renderRows(); changed();
  });

  // Header inputs
  ["goal","eurusd","eurchf","display","last"].forEach(id=>{
    inputs[id].addEventListener("input", e=>{
      state[id] = id==="goal"||id==="eurusd"||id==="eurchf" ? Number(e.target.value||0) : e.target.value;
      changed();
    });
  });

  // Buttons
  document.getElementById("save").addEventListener("click", save);
  document.getElementById("reset").addEventListener("click", ()=>{
    state = JSON.parse(JSON.stringify(defaults)); renderRows(); changed();
  });
  document.getElementById("clear").addEventListener("click", ()=>{
    localStorage.removeItem(KEY); state = JSON.parse(JSON.stringify(defaults)); renderRows(); changed();
  });
  document.getElementById("csv").addEventListener("click", ()=>{
    const head = ["Type","Secteur","Asset","Pays","EUR","Cible%"];
    const rows = state.rows.map(r=>[r.type,r.secteur,r.asset,r.pays,Number(r.eur||0),r.cible]);
    const csv = [head,...rows].map(r=>r.join(",")).join("\n");
    const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download="allocation.csv"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // First render
  renderRows(); renderAll();
})();
</script>
</body>
</html>
